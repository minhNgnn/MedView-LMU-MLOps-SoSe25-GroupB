# Brain Tumor Image Monitoring System

This document describes the comprehensive data drift monitoring system specifically designed for brain tumor image classification using YOLO models.

## Overview

The monitoring system provides real-time tracking of brain tumor image quality, model performance, and data drift detection using Evidently AI. It's specifically optimized for medical image classification with focus on brain tumor detection.

## Features

### ğŸ” Brain Tumor Image Drift Detection
- **Image Feature Analysis**: Monitors brightness, contrast, entropy, and texture characteristics
- **Tumor-Specific Features**: Tracks tumor detection confidence, area ratios, and spatial distribution
- **Statistical Drift Analysis**: Compares current image distributions with reference data
- **Medical Image Quality**: Ensures consistent image quality for accurate diagnosis

### ğŸ“Š Image Quality Monitoring
- **Missing Values Detection**: Identifies incomplete image data
- **Outlier Detection**: Flags anomalous image characteristics
- **Image Completeness**: Ensures required image features are extracted

### ğŸ“ˆ Performance Tracking
- **Prediction Logging**: Records all brain tumor predictions with metadata
- **Confidence Monitoring**: Tracks model confidence scores for tumor detection
- **Classification Distribution**: Monitors malignant/benign/normal prediction frequencies

### ğŸš¨ Alert System
- **Real-time Alerts**: Immediate notification of image drift or quality issues
- **Severity Levels**: Critical, High, Medium, Low alert classifications
- **Medical Context**: Alerts tailored for brain tumor diagnosis requirements

## Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Frontend      â”‚    â”‚   Backend       â”‚    â”‚   Database      â”‚
â”‚   Dashboard     â”‚â—„â”€â”€â–ºâ”‚   FastAPI       â”‚â—„â”€â”€â–ºâ”‚   PostgreSQL    â”‚
â”‚                 â”‚    â”‚   Monitoring    â”‚    â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚   Evidently     â”‚
                       â”‚   Reports       â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Setup Instructions

### 1. Install Dependencies

```bash
# Install monitoring dependencies
pip install evidently pandas nltk anyio opencv-python

# Or install from requirements
pip install -r backend/requirements.txt
```

### 2. Setup Database

```bash
# Run the setup script
python backend/setup_monitoring.py
```

This will:
- Create brain tumor monitoring tables in your database
- Download required NLTK data
- Create reports directory structure

### 3. Configure Environment

Ensure your `.env` file contains:

```env
DATABASE_URL=postgresql://user:password@localhost:5432/database_name
```

### 4. Start the Application

```bash
# Start the backend server
uvicorn backend.src.api:app --reload
```

## API Endpoints

### Brain Tumor Monitoring Dashboard
```http
GET /monitoring/dashboard
```
Returns current brain tumor monitoring metrics and alerts.

### Image Quality Tests
```http
GET /monitoring/data-quality
```
Runs comprehensive brain tumor image quality tests and returns results.

### Generate Drift Report
```http
GET /monitoring/drift-report?days=7
```
Generates a comprehensive brain tumor image drift report for the specified time period.

### View Reports
```http
GET /monitoring/report/{report_name}
```
Returns HTML reports generated by the monitoring system.

## Database Schema

### Brain Tumor Predictions Log Table
```sql
CREATE TABLE predictions_log (
    id SERIAL PRIMARY KEY,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    patient_id INTEGER,
    prediction_confidence FLOAT,
    prediction_class VARCHAR(255),
    num_detections INTEGER,

    -- Image features for brain tumor analysis
    image_width INTEGER,
    image_height INTEGER,
    image_channels INTEGER,
    image_size_bytes BIGINT,
    brightness_mean FLOAT,
    brightness_std FLOAT,
    contrast_mean FLOAT,
    contrast_std FLOAT,
    entropy FLOAT,
    skewness FLOAT,
    kurtosis FLOAT,
    mean_intensity FLOAT,
    std_intensity FLOAT,

    -- Brain tumor specific features
    tumor_area_ratio FLOAT,
    tumor_detection_confidence FLOAT,
    num_tumors_detected INTEGER,
    largest_tumor_area FLOAT,
    tumor_density FLOAT,
    tumor_location_x FLOAT,
    tumor_location_y FLOAT,
    tumor_shape_regularity FLOAT,

    -- Additional metadata
    model_version VARCHAR(100),
    processing_time_ms INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### Brain Tumor Drift Reports Table
```sql
CREATE TABLE drift_reports (
    id SERIAL PRIMARY KEY,
    report_name VARCHAR(255) NOT NULL,
    report_path VARCHAR(500) NOT NULL,
    days_analyzed INTEGER,
    drift_score FLOAT,
    data_quality_score FLOAT,
    image_drift_score FLOAT,
    tumor_feature_drift_score FLOAT,
    generated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    status VARCHAR(50) DEFAULT 'generated'
);
```

### Brain Tumor Monitoring Alerts Table
```sql
CREATE TABLE monitoring_alerts (
    id SERIAL PRIMARY KEY,
    alert_type VARCHAR(100) NOT NULL,
    severity VARCHAR(20) NOT NULL,
    message TEXT NOT NULL,
    details JSONB,
    is_resolved BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    resolved_at TIMESTAMP
);
```

## Frontend Integration

### Add Brain Tumor Monitoring Dashboard

1. Import the component:
```tsx
import MonitoringDashboard from './components/MonitoringDashboard';
```

2. Add to your routing:
```tsx
<Route path="/monitoring" element={<MonitoringDashboard />} />
```

### Dashboard Features

- **Real-time Metrics**: Live updates of prediction counts, confidence scores
- **Tumor Classification**: Breakdown of malignant/benign/normal predictions
- **Image Quality Tests**: Interactive buttons to run quality tests
- **Drift Reports**: Generate and view brain tumor drift analysis reports
- **Alert Management**: View and manage monitoring alerts

## Monitoring Metrics

### Brain Tumor Image Drift Metrics
- **Statistical Distance**: Kolmogorov-Smirnov test for image distribution differences
- **Feature Drift**: Individual image feature drift scores
- **Tumor Detection Drift**: Changes in tumor detection patterns
- **Overall Drift Score**: Composite drift indicator for brain tumor images

### Image Quality Metrics
- **Missing Values**: Percentage of missing image features
- **Outlier Detection**: Statistical outlier identification in image characteristics
- **Image Completeness**: Required image feature validation

### Performance Metrics
- **Prediction Volume**: Number of brain tumor predictions per time period
- **Confidence Distribution**: Model confidence score analysis
- **Classification Distribution**: Malignant/benign/normal prediction frequency analysis
- **Tumor Detection Confidence**: Average confidence in tumor detection

## Brain Tumor Specific Features

### Image Feature Extraction
The system extracts comprehensive features from brain tumor images:

- **Basic Properties**: Width, height, channels, file size
- **Intensity Statistics**: Mean, standard deviation, brightness, contrast
- **Texture Features**: Entropy, skewness, kurtosis
- **Tumor Features**: Detection confidence, area ratios, spatial distribution

### Tumor Detection Monitoring
- **Detection Confidence**: Tracks model confidence in tumor detection
- **Tumor Count**: Number of tumors detected per image
- **Spatial Distribution**: Tumor location patterns
- **Size Analysis**: Tumor area ratios and distributions

## Customization

### Adding Custom Brain Tumor Metrics

1. Extend the `BrainTumorImageMonitor` class:
```python
class CustomBrainTumorMonitor(BrainTumorImageMonitor):
    def custom_tumor_metric(self, image):
        # Your custom brain tumor metric calculation
        return metric_value
```

2. Add to the monitoring endpoints:
```python
@app.get("/monitoring/custom-tumor-metric")
async def get_custom_tumor_metric():
    monitor = get_monitor()
    return {"custom_tumor_metric": monitor.custom_tumor_metric()}
```

### Custom Alert Rules for Brain Tumor Detection

1. Define brain tumor specific alert conditions:
```python
def check_brain_tumor_alert_conditions(self, data):
    if data['tumor_detection_confidence'] < 0.7:
        return {
            'type': 'low_tumor_confidence',
            'severity': 'high',
            'message': 'Low tumor detection confidence detected'
        }
    return None
```

2. Integrate with the monitoring system:
```python
alert = monitor.check_brain_tumor_alert_conditions(data)
if alert:
    monitor.create_alert(alert)
```

## Best Practices for Brain Tumor Monitoring

### 1. Regular Monitoring
- Run image quality tests daily
- Generate drift reports weekly
- Review alerts immediately for critical cases

### 2. Threshold Management
- Set appropriate drift thresholds for medical imaging
- Adjust alert sensitivity based on clinical requirements
- Document threshold rationale for medical compliance

### 3. Data Retention
- Archive old reports periodically
- Clean up resolved alerts
- Maintain reference image quality standards

### 4. Performance Optimization
- Use database indexes for efficient queries
- Implement caching for frequently accessed metrics
- Monitor system resource usage

## Testing

### Run the Test Script
```bash
python backend/test_monitoring.py
```

This will test:
- Image feature extraction
- Synthetic data generation
- Drift report generation
- Quality test execution
- Dashboard data retrieval

## Troubleshooting

### Common Issues

1. **Database Connection Errors**
   - Verify DATABASE_URL environment variable
   - Check database permissions
   - Ensure PostgreSQL is running

2. **Missing Dependencies**
   - Install all required packages
   - Check Python version compatibility
   - Verify OpenCV installation

3. **Report Generation Failures**
   - Ensure sufficient image data for analysis
   - Check file permissions for reports directory
   - Verify Evidently version compatibility

### Debug Mode

Enable debug logging:
```python
import logging
logging.basicConfig(level=logging.DEBUG)
```

## Future Enhancements

### Planned Features
- **Real-time Image Streaming**: Live brain tumor image drift detection
- **ML Model Retraining**: Automatic retraining triggers based on drift
- **Advanced Visualizations**: Interactive brain tumor analysis charts
- **Medical Integration**: Connect with hospital information systems

### Performance Improvements
- **Caching Layer**: Redis integration for faster queries
- **Async Processing**: Background report generation
- **Distributed Monitoring**: Multi-service monitoring support

## Medical Compliance

### Healthcare Standards
- **HIPAA Compliance**: Patient data protection
- **Medical Device Standards**: FDA compliance considerations
- **Clinical Validation**: Medical accuracy requirements
- **Audit Trails**: Complete monitoring history

## Support

For issues or questions:
1. Check the troubleshooting section
2. Review the API documentation
3. Examine the database logs
4. Contact the development team

## Contributing

To contribute to the brain tumor monitoring system:
1. Follow the existing code structure
2. Add comprehensive tests
3. Update documentation
4. Submit pull requests with detailed descriptions
